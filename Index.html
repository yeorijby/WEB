<!DOCTYPE html>
<html>
  <head>
    <meta charset="Utf-8" />
    <title>
      지도에 열고/닫기 가능한 정보 마크 올리기 - 배열을 하드코딩으로 넣었음 -
      받아 올수만 있으면 될듯!
    </title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
    <script
      type="text/javascript"
      src="//dapi.kakao.com/v2/maps/sdk.js?appkey=920f04a92b0d4bff8ceccf191eede4a3&libraries=services"
    ></script>
  </head>
  <body>
    <div class="map_wrap">
      <div
        id="map"
        style="width: 100%; height: 100%; position: relative; overflow: hidden"
      ></div>
      <!-- 지도타입 컨트롤 div 입니다 -->
      <div class="custom_typecontrol radius_border">
        <span
          id="btnRoadmap"
          class="selected_btn"
          onclick="setMapType('roadmap')"
          >지도</span
        >
        <span id="btnSkyview" class="btn" onclick="setMapType('skyview')"
          >스카이뷰</span
        >
      </div>
      <!-- 지도 확대, 축소 컨트롤 div 입니다 -->
      <div class="custom_zoomcontrol radius_border">
        <span onclick="zoomIn()"
          ><img
            src="https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/ico_plus.png"
            alt="확대"
        /></span>
        <span onclick="zoomOut()"
          ><img
            src="https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/ico_minus.png"
            alt="축소"
        /></span>
      </div>
    </div>
    <script src="function.js"></script>
    <script>
      //CustomOverlay("카카오라카이구래쌌노", 33.450701, 126.570667);

      var xhr = new XMLHttpRequest();
        var jsonResponse;
        var api_key = "3c3198ef4877402c9361a69a6c47398b";
        var url = 'https://openapi.gg.go.kr/MskulM'; /*URL*/
        var queryParams = '?' + encodeURIComponent('Key') + '='+api_key; /*Service Key*/
        queryParams += '&' + encodeURIComponent('type') + '=' + encodeURIComponent('json'); /**/
        queryParams += '&' + encodeURIComponent('pIndex') + '=' + encodeURIComponent(1); /**/
        queryParams += '&' + encodeURIComponent('pSize') + '=' + encodeURIComponent(1000); /**/

        let fetchArray = [];      // 최종 주소록 배열
        let myArray = [];         // 단일 행(학교당) 주소 정보
        let schoolMem = {};       // 학교당 멤버(배열인자:학교명, 값:학생명 누적) // json
        let schoolMemArray = [];  // 학교당 멤버(배열인자:학교명, 값:학생명 누적) // json의 배열
        let strName = "";
        let nANC_Count = 0;      // 귀찮아서 콘솔로그 보기 편하라고 
        let nSelSchoolANC_First;
        let jsonData_E_M_H_ShoolInfo;
        let jsonData_ANC;

        // SCHOOL_RK_DIV_NM        url + queryParams
        xhr.open('GET', url + queryParams);
        
        fetch(url + queryParams)
        .then((response) => {
          return response.json();
        })
        .then((jsondata) => {
          jsonData_E_M_H_ShoolInfo = jsondata;
          console.log(jsonData_E_M_H_ShoolInfo);

          // 1. 가져온 값의 갯수를 찍어본다.
          let obj = jsonData_E_M_H_ShoolInfo['MskulM'][1]['row'];
          let cntTotalSchool = obj.length;
          console.log(cntTotalSchool);


          fetch("./addr.json")
          .then((response) => {
            return response.json();
          })
          .then((jsondata) => {
            jsonData_ANC = jsondata;
            console.log("전체학교 : ", cntTotalSchool);
            console.log("학생정보 : ", jsonData_ANC);

            let cntTotalANC = jsonData_ANC.length;
            console.log(cntTotalANC);

            // 2. 갯수만큼 반복해서 찾아본다.
            for(let j=0;j<cntTotalSchool;j++)         // 전체학교
            {
              nSelSchoolANC_First = 0;
              strName = "";
              myArray.length = 0;
              for(let l = 0 ; l < cntTotalANC ; l++)  // ANC 학교
              {
                if (obj[j].FACLT_NM != jsonData_ANC[l]['School']) 
                  continue;

                  //myArray.length = 0;
                // if (schoolMem[`${obj[j].FACLT_NM}`] == null)
                //   schoolMem[`${obj[j].FACLT_NM}`] = jsonData_ANC[l]['Name'];
                // else
                //   schoolMem[`${obj[j].FACLT_NM}`] += (", " + jsonData_ANC[l]['Name']);

                // 1. 처음 들어온것인지 확인한다.
                if (nSelSchoolANC_First == 0)
                {
                  // 1.1 처음 들어왔다면 - 해당 학생을 변수에 담는다.
                  if (nANC_Count > 0 && strName != "")
                  {
                    if (myArray.length != 0)
                    {
                      myArray.push(strName);

                      console.log(`myArray.length = ${myArray.length} nANC_Count = ${nANC_Count} strName = ${strName} myArray= ${myArray}`);
                      
                      //console.log(myArray);
                      fetchArray.push(myArray);
                    }
                    //fetchArray[nANC_Count-1].push(strName);

                  //   // console.log("ANC_Count : ", nANC_Count);
                  //   // console.log("strName : ", strName);
                  }
                    
                  //console.log("ANC_Count : ", nANC_Count);
                  //console.log("strName : ", strName);

                  myArray.length = 0;
                  
                  myArray.push(obj[j].FACLT_NM);
                  myArray.push('이미지 없음');
                  myArray.push(obj[j].REFINE_LOTNO_ADDR);
                  myArray.push(obj[j].REFINE_ROADNM_ADDR);
                  myArray.push('홈페이지 없음');
                  myArray.push(obj[j].REFINE_WGS84_LAT);
                  myArray.push(obj[j].REFINE_WGS84_LOGT);

                  //fetchArray.push(myArray);

                  console.log(fetchArray);

                  strName = jsonData_ANC[l]['Name'];
                  nANC_Count++;
                }
                else 
                {
                  // 1.2 처음 들어온것이 아니라면 - 학생을 누적시킨다. 
                  strName += (", " + jsonData_ANC[l]['Name']);
                }
              }
              if (myArray.length == 0 || nANC_Count == 0)
                continue;

              fetchArray.push(myArray);
            } 

            console.log(fetchArray);

          })
        })
        .catch((error) => console.log("error : ", error));


//console.log(nANC_Count);
          //console.log(fetchArray);

          // let nFetchArrCnt = fetchArray.length;
          // let nSchoolMemCnt = schoolMem.length;

          // console.log(nFetchArrCnt);
          // console.log(nANC_Count);

          // for(let m = 0 ; m < nANC_Count ; m++)
          // {
          //   for(let n = 0;n<fetchArray.length;n++)
          //   {
          //     if (schoolMem[m].school != fetchArray[n][0])
          //       contiue;

          //     fetchArray[n].push(schoolMem[m].name);
          //   }
          // }

          //console.log(fetchArray);

          // schoolMem.forEach((element) => {
            

          // });
          
//*/
      
      // var arrLocationInfo = [
      //   [
      //     "카카오 스페이스닷원",
      //     "https://t1.kakaocdn.net/kakaocorp/kakaocorp/admin/community/83cd8a98017a00001.png",    // 없애자
      //     "제주특별자치도 제주시 첨단로 242",
      //     "(우) 63309 (지번) 영평동 2181",
      //     "https://www.kakaocorp.com/main",
      //     33.450701,
      //     126.570667,
      //   ],
      //   [
      //     "전기차 배터리 산업화 센터",
      //     "https://lh5.googleusercontent.com/p/AF1QipOm59iilr97JMp8vG6UCFjdzD0JaLO1a_og1UOm=w426-h240-k-no",
      //     "제주특별자치도 제주시 첨단로 241",
      //     "(우) 63309 (지번) 영평동 2181", // 안바꿈
      //     "https://www.kakaocorp.com/main", // 안바꿈
      //     33.450725,
      //     126.57222,
      //   ],
      // ];
      //console.log(fetchArray);

      var i = 1; // 이런 경우 굳이 인덱스 일 필요(0으로 시작할 필요)가?


      var mapContainer = document.getElementById("map"), // 지도를 표시할 div
        mapOption = {
          center: new kakao.maps.LatLng(33.450701, 126.570667), // 지도의 중심좌표
          level: 3, // 지도의 확대 레벨
        };

      var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다

      fetchArray.forEach((element) => {
        // console.log(element);

        var latitude = element[5];
        var longitude = element[6];

        // 지도에 마커를 표시합니다
        var marker = new kakao.maps.Marker({
          map: map,
          position: new kakao.maps.LatLng(latitude, longitude),
        });

        // 커스텀 오버레이가 표시될 위치입니다
        var position = new kakao.maps.LatLng(latitude, longitude);

        var content = CreateContentsTag(
          i,
          element[0], // "카카오 스페이스닷원",
          element[1], // "https://t1.kakaocdn.net/kakaocorp/kakaocorp/admin/community/83cd8a98017a00001.png", //"https://cfile181.uf.daum.net/image/250649365602043421936D",
          element[2], // "제주특별자치도 제주시 첨단로 242",
          element[3], // "(우) 63309 (지번) 영평동 2181",
          element[4], // "https://www.kakaocorp.com/main",
          // latitude,
          // longitude,
          element[7]
        );

        // 커스텀 오버레이를 생성합니다
        var customOverlay = new kakao.maps.CustomOverlay({
          content: content,
          map: map,
          position: marker.getPosition(),
        });

        // 마커를 클릭했을 때 커스텀 오버레이를 표시합니다
        kakao.maps.event.addListener(marker, "click", function () {
          customOverlay.setMap(map);
        });

        // 닫는 동작 하기 위해서
        var getElementById = "info_close" + i;
        document
          .getElementById(getElementById)
          .addEventListener("click", function (event) {
            customOverlay.setMap(null);
          });

        i++;
      });
    </script>
  </body>
</html>
